<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GERAGANAMOS</title>
  <link rel="icon" href="imagenes/favicon.png" type="image/png" />
  <link rel="stylesheet" href="./styles.css" />

  <!-- Performancee -->
  <link rel="preconnect" href="https://connect.facebook.net" crossorigin>
  <link rel="dns-prefetch" href="//connect.facebook.net">
  <link rel="preload" href="imagenes/fondo.png" as="image">

  <!-- Meta Pixel Code (con coincidencias avanzadas) -->
  <script>
    function normEmail(v){return(v||"").trim().toLowerCase();}
    function normPhone(v){let p=(v||"").replace(/\D+/g,"");if(p&&p.length===10)p="54"+p;return p;}
    function safeUUID(){return crypto?.randomUUID?.()||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==="x"?r:r&0x3|0x8;return v.toString(16)})}
    function getOrCreateExternalId(){let id=localStorage.getItem("external_id");if(!id){id=safeUUID();localStorage.setItem("external_id",id);}return id;}
    const params=new URLSearchParams(location.search);
    const userEmail=normEmail(params.get("email"));
    const userPhone=normPhone(params.get("phone"));
    const externalId=getOrCreateExternalId();
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    window.fbq=window.fbq||function(){console.warn("Meta Pixel no inicializado")};
    fbq("init","868127886154248",{external_id:externalId,em:userEmail||void 0,ph:userPhone||void 0,country:"AR"});
    fbq("track","PageView");
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=868127886154248&ev=PageView&noscript=1"/></noscript>
  <!-- End Meta Pixel Code -->
</head>

<body>
  <div class="container background-image">
    <div class="overlay"></div>
    <div class="content">
      <img src="imagenes/logo.png" class="logo" alt="Logo Chiva77"
           width="240" height="120" decoding="async" fetchpriority="high" />
      <p class="title">Envianos un WhatsApp<br />para crear tu cuenta</p>

      <a class="whatsapp-button" id="whatsappButton">
        <span>Â¡PedÃ­ tu bono y empeza a jugar!</span>
        <img src="imagenes/whatsapp.png" alt="whatsapp" class="whatsapp-icon"
             width="24" height="24" decoding="async" loading="lazy" />
      </a>

      <p class="subtitle">MÃ­nimo de carga: 1.000<br />SÃ­n LÃ­mite de retiro<br />GanÃ¡s y cobrÃ¡s a cualquier hora</p>
      <p class="description">-GERA GANAMOS-</p>
    </div>
  </div>

  <!-- âœ… Floating WhatsApp + Burbuja -->
  <div id="wa-float" class="wa-float" aria-hidden="false">
    <button id="wa-float-btn" class="wa-float__btn" aria-label="Abrir WhatsApp">
      <img src="imagenes/whatsapp.png" alt="whatsapp" class="wa-float__icon" />
    </button>

    <div id="wa-bubble" class="wa-bubble" role="dialog" aria-label="Chat WhatsApp">
      <div class="wa-bubble__header">
        <div class="wa-bubble__title">WhatsApp</div>
        <button id="wa-bubble-close" class="wa-bubble__close" aria-label="Cerrar">âœ•</button>
      </div>

      <div class="wa-bubble__body">
        <div class="wa-msg wa-msg--bot">Â¡Bienvenido!ðŸ‘‹</div>
      </div>

      <div class="wa-bubble__footer">
        <input id="wa-input" class="wa-input" type="text" value="Hola! Quiero info" />
        <button id="wa-send" class="wa-send">Enviar</button>
      </div>
    </div>
  </div>

  <!-- âœ… Overlay auto-redirect -->
  <div id="wa-redirect-overlay" class="wa-redirect-overlay" hidden>
    <div class="wa-redirect-box">
      <div class="wa-redirect-spinner"></div>
      <div id="wa-redirect-text" class="wa-redirect-text">Redirigiendo al Whatsapp del Cajero...</div>
    </div>
  </div>

<script>
/*************** CONFIGURACIÃ“N ***************/
const CONFIG_FRONT = {
  SERVICE_URL: "/api/get-random-phone",
  FALLBACK: [{ number: "5491169789243", name: "Soporte Gera", weight: 1 }],
  TTL_MS: 5*60*1000,
  LS_KEY: "active_whatsapp_numbers:totiylola",
  ENVIAR_PROMO_CODE: true,
  LANDING_TAG: "CH1",

  // âœ… Auto-redirect (FLAG)
  AUTO_REDIRECT_ENABLED: false,          // <- ponelo true para activar
  AUTO_REDIRECT_DELAY_MS: 10000,         // 10 segundos
  AUTO_REDIRECT_TEXT: "Redirigiendo al Whatsapp del Cajero..."
};

/*************** FUNCIONES AUXILIARES ***************/
function fetchWithTimeout(url,opt={},ms=3000){
  const ctrl=new AbortController();const id=setTimeout(()=>ctrl.abort(),ms);
  return fetch(url,{...opt,signal:ctrl.signal}).finally(()=>clearTimeout(id));
}
function getCache(){try{return JSON.parse(localStorage.getItem(CONFIG_FRONT.LS_KEY)||"null");}catch{return null;}}
function setCache(numbers){localStorage.setItem(CONFIG_FRONT.LS_KEY,JSON.stringify({ts:Date.now(),numbers}));}
function normalizeNumbers(list){return(Array.isArray(list)?list:[]).map(n=>({number:String(n.number||n.phone||"").trim(),weight:Number(n.weight||1),name:n.name||"Toti"})).filter(n=>/^\+?\d{8,17}$/.test(n.number));}
async function loadNumbersOnce(){
  const cached=getCache();
  try{
    const res=await fetchWithTimeout(CONFIG_FRONT.SERVICE_URL,{headers:{"Cache-Control":"no-store"}},2000);
    if(!res.ok)throw new Error("HTTP "+res.status);
    const data=await res.json();
    const list=normalizeNumbers(Array.isArray(data)?data:[data]);
    if(list.length){setCache(list);return list;}
    throw new Error("Invalid data");
  }catch(e){
    const ok=cached?.numbers?.length&&Date.now()-(cached.ts||0)<CONFIG_FRONT.TTL_MS;
    return ok?cached.numbers:CONFIG_FRONT.FALLBACK;
  }
}
function pickWeightedRandom(list){
  const total=list.reduce((s,it)=>s+(Number(it.weight)||1),0);
  let r=Math.random()*total;
  for(const it of list){r-=(Number(it.weight)||1);if(r<=0)return it;}
  return list[list.length-1];
}

/*************** FUNCIONES CAPI Y GEO ***************/
const qs=new URLSearchParams(location.search);
const getQueryParam=p=>qs.get(p);
const getCookie=name=>{const m=document.cookie.match(new RegExp("(^| )"+name+"=([^;]+)"));return m&&m[2];};
function getFbc(){const c=getCookie("_fbc");if(c){localStorage.setItem("stored_fbc",c);return c;}
  const s=localStorage.getItem("stored_fbc");if(s)return s;const fbclid=getQueryParam("fbclid");
  if(!fbclid)return;const fbc=`fb.1.${Date.now()}.${fbclid}`;localStorage.setItem("stored_fbc",fbc);return fbc;}
function getFbp(){const c=getCookie("_fbp");if(c){localStorage.setItem("stored_fbp",c);return c;}
  const s=localStorage.getItem("stored_fbp");if(s)return s;const n=`fb.1.${Date.now()}.${Math.floor(Math.random()*1e10)}`;
  localStorage.setItem("stored_fbp",n);return n;}
function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==="x"?r:r&0x3|0x8;return v.toString(16)})}
function getDeviceType(){const ua=navigator.userAgent;if(/mobile/i.test(ua))return"mobile";if(/tablet|ipad|playbook|silk/i.test(ua))return"tablet";return"desktop";}
async function detectarGeo(timeoutMs=700){try{const ctrl=new AbortController();const t=setTimeout(()=>ctrl.abort(),timeoutMs);
  const res=await fetch("https://ipapi.co/json/",{signal:ctrl.signal,cache:"no-store"});clearTimeout(t);const d=await res.json();
  return{country:d.country||null,region:d.region||null,city:d.city||null};}catch{return{country:null,region:null,city:null};}}

/*************** GENERADOR DE MENSAJE ***************/
function buildMensaje(botName, promo_code){
  const variantes = [
    n => `Hola ${n}! Vi este anuncio, me pasÃ¡s info?`,
    n => `Hola ${n}! Vi el anuncio, podrÃ­as darme mÃ¡s info?`,
    n => `Buenas ${n}! Me contÃ¡s un poco mÃ¡s del anuncio?`,
    n => `Hola ${n}! Quisiera saber mÃ¡s sobre lo que ofrecen.`,
    n => `Buenas ${n}! Me das mÃ¡s detalles por favor?`,
    n => `Hola ${n}! Estoy interesado, me contÃ¡s cÃ³mo funciona?`,
    n => `Hola ${n}! Vi tu publicaciÃ³n, podrÃ­as ampliarme la info?`,
    n => `Holaaa ${n}! Me llamÃ³ la atenciÃ³n el anuncio, me contÃ¡s mÃ¡s?`,
    n => `Hola ${n}! Vi tu publicidad, cÃ³mo es para registrarse?`,
    n => `Buenas ${n}! Me das informaciÃ³n sobre cÃ³mo empezar?`,
    n => `QuÃ© tal ${n}! Me podÃ©s explicar cÃ³mo funciona?`,
    n => `Hola ${n}! Quisiera saber cÃ³mo se juega, me ayudÃ¡s?`,
    n => `Holaaa ${n}! Vi el anuncio, me pasÃ¡s los pasos para entrar?`,
    n => `Buenas ${n}! Me interesa, me contÃ¡s un poco mÃ¡s?`,
    n => `Hola ${n}! Vi su anuncio, tienen bono de bienvenida?`,
    n => `Holaaa ${n}! Me podÃ©s contar un poco mÃ¡s del sistema?`,
    n => `Buenas ${n}! Vi la publicidad y quiero saber mÃ¡s.`,
    n => `Hola ${n}! CÃ³mo hago para crear mi usuario?`,
    n => `Holaaa ${n}! Me gustarÃ­a probar, cÃ³mo empiezo?`,
    n => `Buenas ${n}! Me interesa, cÃ³mo funciona la plataforma?`,
    n => `Hola ${n}! Me pasÃ¡s info sobre cÃ³mo registrarme?`,
    n => `Holaaa ${n}! Me contÃ¡s mÃ¡s sobre lo que ofrecen?`,
    n => `Buenas ${n}! Vi su anuncio, me explicÃ¡s cÃ³mo participar?`,
    n => `Hola ${n}! Vi este anuncio y quiero saber cÃ³mo funciona.`,
    n => `Holaaa ${n}! Me podrÃ­as dar mÃ¡s informaciÃ³n?`,
    n => `Buenas ${n}! Estoy interesado, me pasÃ¡s mÃ¡s detalles?`,
    n => `Hola ${n}! Vi el anuncio y quiero saber cÃ³mo se juega.`,
    n => `Holaaa ${n}! Vi la publi, me contÃ¡s de quÃ© trata?`,
    n => `Buenas ${n}! Quiero saber mÃ¡s sobre el servicio que ofrecen.`,
    n => `Hola ${n}! PodÃ©s darme mÃ¡s info sobre cÃ³mo arrancar?`,
    n => `Holaaa ${n}! Me explicÃ¡s cÃ³mo funciona el proceso?`,
    n => `Buenas ${n}! Me interesa participar, me contÃ¡s cÃ³mo es?`,
    n => `Hola ${n}! Vi la publicidad, me das mÃ¡s detalles?`,
    n => `Holaaa ${n}! Quisiera saber cÃ³mo puedo registrarme.`,
    n => `Buenas ${n}! Vi el anuncio y quiero empezar, cÃ³mo hago?`,
    n => `Hola ${n}! Estoy interesado en mÃ¡s informaciÃ³n.`,
    n => `Holaaa ${n}! Me contÃ¡s cÃ³mo es el tema del registro?`,
    n => `Buenas ${n}! Vi la publicaciÃ³n y me gustarÃ­a saber mÃ¡s.`,
    n => `Hola ${n}! Me explicÃ¡s cÃ³mo se gana o cÃ³mo funciona?`,
    n => `Holaaa ${n}! Me gustarÃ­a saber mÃ¡s antes de registrarme.`,
    n => `Buenas ${n}! Vi el anuncio y quiero info para empezar.`,
    n => `Hola ${n}! PodÃ©s contarme cÃ³mo es el proceso paso a paso?`,
    n => `Holaaa ${n}! Vi su publicidad, me gustarÃ­a mÃ¡s info.`,
    n => `Buenas ${n}! Me interesa, tienen algÃºn bono de registro?`,
    n => `Hola ${n}! CÃ³mo hago para jugar o participar?`,
    n => `Holaaa ${n}! Me podÃ©s dar mÃ¡s info por favor?`,
    n => `Buenas ${n}! Vi su anuncio, me gustarÃ­a probar.`,
    n => `Hola ${n}! Vi la publicaciÃ³n y quiero saber mÃ¡s detalles.`,
    n => `Holaaa ${n}! Me interesa lo que ofrecen, cÃ³mo empiezo?`
  ];

  const base = variantes[Math.floor(Math.random()*variantes.length)](botName || "Soporte");
  return promo_code ? `${base} ${promo_code}` : base;
}

/*************** CONTACTAR (Ãºnica lÃ³gica) ***************/
async function contactarWhatsApp({ source="main_button", customText=null } = {}){
  if (window.__waInFlight) return;
  window.__waInFlight = true;

  // nÃºmeros (cacheados)
  const activeNumbers = (window.__activeNumbers && window.__activeNumbers.length)
    ? window.__activeNumbers
    : CONFIG_FRONT.FALLBACK;

  const picked = activeNumbers.length ? pickWeightedRandom(activeNumbers) : CONFIG_FRONT.FALLBACK[0];
  const telefono = picked.number;
  const botName  = picked.name;

  const cleanPhone = String(telefono).replace("+","").trim();
  const external_id = getOrCreateExternalId();
  const event_id = generateUUID();
  const event_source_url = location.href;
  const fbp = getFbp();
  const fbc = getFbc();

  const uuidSegment = generateUUID().replace(/-/g,"").slice(0,12);
  const promo_code = CONFIG_FRONT.ENVIAR_PROMO_CODE ? `${CONFIG_FRONT.LANDING_TAG}-${uuidSegment}` : "";

  const mensaje = (customText && String(customText).trim())
    ? (promo_code ? `${String(customText).trim()} ${promo_code}` : String(customText).trim())
    : buildMensaje(botName, promo_code);

  // Pixel (con event_id para deduplicaciÃ³n)
  if (window.fbq){
    fbq(
      "track",
      "Contact",
      {
        content_name: "BotÃ³n WhatsApp",
        content_category: "LeadGen",
        event_source: "LandingPage",
        source
      },
      { eventID: event_id }
    );
  }

  // Abrir WA
  setTimeout(()=>{ window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(mensaje)}`,"_blank","noopener"); }, 200);

  // Backend / Sheets / CAPI
  try{
    const geo = await detectarGeo();
    const payload = {
      event_name:"Contact",
      event_id,
      external_id,
      event_source_url,
      fbp,
      fbc,
      email:getQueryParam("email"),
      phone:getQueryParam("phone"),
      fn:getQueryParam("fn"),
      ln:getQueryParam("ln"),
      ct:getQueryParam("ct"),
      st:getQueryParam("st"),
      zip:getQueryParam("zip"),
      country:getQueryParam("country"),
      geo_city:geo.city,
      geo_region:geo.region,
      geo_country:geo.country,
      utm_campaign:getQueryParam("utm_campaign"),
      telefono_asignado:cleanPhone,
      device_type:getDeviceType(),
      promo_code,
      source
    };

    fetch("/api/xz3v2q",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload),
      keepalive:true
    }).catch(console.error);
  } finally {
    setTimeout(()=>{ window.__waInFlight = false; }, 800);
  }
}

/*************** PRINCIPAL ***************/
document.addEventListener("DOMContentLoaded",()=>{
  const btn = document.getElementById("whatsappButton");
  if(!btn) return;

  // precarga nÃºmeros para ambos botones
  window.__activeNumbers = [];
  loadNumbersOnce().then(list => { window.__activeNumbers = list || []; });

  // BotÃ³n grande
  btn.addEventListener("click", async (e)=>{
    e.preventDefault();
    contactarWhatsApp({ source: "main_button" });
  });

  // Floating + burbuja
  const floatBtn = document.getElementById("wa-float-btn");
  const bubble   = document.getElementById("wa-bubble");
  const closeBtn = document.getElementById("wa-bubble-close");
  const sendBtn  = document.getElementById("wa-send");
  const input    = document.getElementById("wa-input");

  let openedOnce = false;
  function openBubble(){ bubble.classList.add("is-open"); openedOnce = true; }
  function closeBubble(){ bubble.classList.remove("is-open"); }
  function toggleBubble(){ bubble.classList.toggle("is-open"); openedOnce = true; }

  // aparece a los 3.5s
  window.addEventListener("load", ()=>{
    setTimeout(()=>{ if(!openedOnce) openBubble(); }, 3500);
  });

  floatBtn.addEventListener("click", toggleBubble);
  closeBtn.addEventListener("click", closeBubble);

  sendBtn.addEventListener("click", ()=>{
    const text = (input.value || "Hola! Quiero info").trim();
    contactarWhatsApp({ source:"floating", customText: text });
    closeBubble();
  });

  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      const text = (input.value || "Hola! Quiero info").trim();
      contactarWhatsApp({ source:"floating", customText: text });
      closeBubble();
    }
  });

  // âœ… Auto redirect (SOLO redirige a wa.me, NO pixel, NO sheets)
  if (CONFIG_FRONT.AUTO_REDIRECT_ENABLED) {
    const KEY = "wa_auto_redirect_fired";
    const already = sessionStorage.getItem(KEY) === "1";

    // ðŸ”’ Asegura overlay oculto al inicio
    const ovBoot = document.getElementById("wa-redirect-overlay");
    if (ovBoot) ovBoot.hidden = true;

    window.addEventListener("load", () => {
      setTimeout(async () => {
        if (already) return;
        if (window.__waInFlight) return; // si el user ya tocÃ³ algÃºn botÃ³n

        sessionStorage.setItem(KEY, "1");

        // Mostrar cartel
        const ov = document.getElementById("wa-redirect-overlay");
        const tx = document.getElementById("wa-redirect-text");
        if (tx) tx.textContent = CONFIG_FRONT.AUTO_REDIRECT_TEXT || "Redirigiendo al Whatsapp del Cajero...";
        if (ov) ov.hidden = false;

        // Traer nÃºmeros (API/cache) y elegir uno
        let list = [];
        try {
          list = (window.__activeNumbers && window.__activeNumbers.length)
            ? window.__activeNumbers
            : await loadNumbersOnce();
        } catch (e) {
          list = CONFIG_FRONT.FALLBACK;
        }

        const picked = (list && list.length) ? pickWeightedRandom(list) : CONFIG_FRONT.FALLBACK[0];
        const cleanPhone = String(picked.number || "").replace("+", "").trim();

        // Mensaje fijo (o vacÃ­o si querÃ©s)
        const msg = encodeURIComponent("Redirigiendo al Whatsapp del Cajero...");
        const waUrl = `https://wa.me/${cleanPhone}?text=${msg}`;

        // âœ… RedirecciÃ³n en la MISMA pestaÃ±a (para que no lo bloquee el navegador)
        window.location.assign(waUrl);

      }, CONFIG_FRONT.AUTO_REDIRECT_DELAY_MS || 10000);
    });
  }
});
</script>
</body>
</html>
