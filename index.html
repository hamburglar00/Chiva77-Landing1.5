<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GERALDINA</title>

<link rel="icon" href="imagenes/favicon.png" type="image/png" />
<link rel="stylesheet" href="./styles.css" />

<link rel="preconnect" href="https://connect.facebook.net" crossorigin>
<link rel="dns-prefetch" href="//connect.facebook.net">
<link rel="preload" as="image" href="imagenes/fondo.avif" type="image/avif" fetchpriority="high">
<link rel="preload" as="image" href="imagenes/fondo.png">

<script>
function normEmail(v){return(v||"").trim().toLowerCase();}
function normPhone(v){let p=(v||"").replace(/\D+/g,"");if(p&&p.length===10)p="54"+p;return p;}
function safeUUID(){return crypto?.randomUUID?.()||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==="x"?r:r&0x3|0x8;return v.toString(16)})}
function getOrCreateExternalId(){let id=localStorage.getItem("external_id");if(!id){id=safeUUID();localStorage.setItem("external_id",id);}return id;}

const params=new URLSearchParams(location.search);
const userEmail=normEmail(params.get("email"));
const userPhone=normPhone(params.get("phone"));
const externalId=getOrCreateExternalId();

!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq("init","1849164609062818",{external_id:externalId,em:userEmail||void 0,ph:userPhone||void 0,country:"AR"});
fbq("track","PageView");
</script>

<noscript>
<img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1849164609062818&ev=PageView&noscript=1"/>
</noscript>
</head>

<body>
<div class="container background-image">
<div class="overlay"></div>
<div class="content">

<img src="imagenes/logo.png" class="logo" alt="Logo" decoding="async" fetchpriority="high" />

<p class="title">
Envianos un WhatsApp<br />para crear tu cuenta
</p>

<a class="whatsapp-button" id="whatsappButton" href="#" rel="noopener noreferrer">
<span>¡Contactar ya!</span>
<img src="imagenes/whatsapp.png" alt="whatsapp" class="whatsapp-icon"
width="24" height="24" decoding="async" loading="lazy" />
</a>

<p class="subtitle">
Mínimo de carga: 1.000<br />
Sin Límite de retiro<br />
Ganás y cobrás a cualquier hora
</p>

<p class="description">-RED OFICIAL-</p>

</div>
</div>

<script>
/*************************************************************
 * ✅ CONFIG (se mantiene tu lógica tal cual)
 *************************************************************/
const LANDING_CONFIG = {
  MODE: "ads",

  // ✅ Nuevo: pool cacheado por Vercel
  POOL_URL: "/api/phones-pool",

  PROMO: { ENABLED: true, LANDING_TAG: "CH1" },

  // ✅ Nuevo: refresh/caché del pool
  POOL_REFRESH_MS: 15 * 60 * 1000, // 15 min
  POOL_TTL_MS: 20 * 60 * 1000,     // 20 min (un poco > refresh)
  POOL_FETCH_TIMEOUT_MS: 1600      // si NO hay cache, cuánto esperamos
};

function normalizePhoneDigits(raw){
  return String(raw||"").replace(/\D+/g,"").trim();
}

function generateUUID(){
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{
    const r=Math.random()*16|0,v=c==="x"?r:r&0x3|0x8;
    return v.toString(16);
  });
}

/*************************************************************
 * ✅ NUEVO: Pool cache + round-robin (sin fallback)
 *************************************************************/
const POOL_KEY = "wa_ads_pool";
const RR_KEY   = "wa_rr_index";

function fetchWithTimeout(url, opt={}, ms=1600){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), ms);
  return fetch(url, { ...opt, signal: ctrl.signal }).finally(()=>clearTimeout(id));
}

function savePool(numbers){
  try{
    localStorage.setItem(POOL_KEY, JSON.stringify({ numbers, ts: Date.now() }));
  }catch{}
}

function loadPool(){
  try{
    const raw = localStorage.getItem(POOL_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!Array.isArray(obj?.numbers) || obj.numbers.length === 0) return null;
    if((Date.now() - obj.ts) > LANDING_CONFIG.POOL_TTL_MS) return null;

    const clean = obj.numbers
      .map(normalizePhoneDigits)
      .filter(n => /^\d{8,17}$/.test(n));

    return clean.length ? clean : null;
  }catch{
    return null;
  }
}

function pickRoundRobin(arr){
  let i = parseInt(localStorage.getItem(RR_KEY) || "0", 10);
  if (!Number.isFinite(i) || i < 0) i = 0;
  const n = arr[i % arr.length];
  localStorage.setItem(RR_KEY, String((i + 1) % arr.length));
  return n;
}

async function refreshPoolOnce(){
  const res = await fetchWithTimeout(
    LANDING_CONFIG.POOL_URL,
    { cache:"no-store" },
    LANDING_CONFIG.POOL_FETCH_TIMEOUT_MS
  );
  if(!res.ok) throw new Error("POOL HTTP " + res.status);
  const data = await res.json();

  const nums = Array.isArray(data?.numbers) ? data.numbers : [];
  const clean = nums.map(normalizePhoneDigits).filter(n => /^\d{8,17}$/.test(n));
  if(!clean.length) throw new Error("POOL EMPTY");

  savePool(clean);
  return clean;
}

function refreshPoolBackground(){
  refreshPoolOnce().catch(()=>{});
}

async function getNumberFromPool(){
  // 1) cache local (instantáneo)
  const cached = loadPool();
  if(cached) return pickRoundRobin(cached);

  // 2) si no hay cache, consultamos pool y recién ahí devolvemos número (SIN FALLBACK)
  const fresh = await refreshPoolOnce();
  return pickRoundRobin(fresh);
}

/*************************************************************
 * ✅ Tu flujo original (promo_code, mensaje, pixel) TAL CUAL
 *************************************************************/
async function contactarWhatsApp(){
  if(window.__waInFlight) return;
  window.__waInFlight=true;

  let phone;
  try{
    // ✅ antes: await getNumberFromApi()
    // ✅ ahora: pool cacheado + round-robin
    phone = await getNumberFromPool();
  }catch{
    window.__waInFlight=false;
    return;
  }

  if(!phone){
    window.__waInFlight=false;
    return;
  }

  const promo_code = LANDING_CONFIG.PROMO.ENABLED
    ? `${LANDING_CONFIG.PROMO.LANDING_TAG}-${generateUUID().slice(0,8)}`
    : "";

  const mensaje = `Hola! Quiero info ${promo_code}`;
  const event_id = generateUUID();

  try{
    fbq("track","Contact",{content_name:"Botón WhatsApp"},{eventID:event_id});
  }catch{}

  window.location.assign(`https://wa.me/${phone}?text=${encodeURIComponent(mensaje)}`);
}

document.addEventListener("DOMContentLoaded",()=>{
  // ✅ Nuevo: precargar pool (no bloquea)
  refreshPoolBackground();

  // ✅ Nuevo: refrescar cada 15 min
  setInterval(refreshPoolBackground, LANDING_CONFIG.POOL_REFRESH_MS);

  // ✅ Nuevo: refrescar al volver a la pestaña
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") refreshPoolBackground();
  });

  const btn=document.getElementById("whatsappButton");
  if(btn){
    btn.addEventListener("click",(e)=>{
      e.preventDefault();
      contactarWhatsApp();
    });
  }
});
</script>

</body>
</html>
